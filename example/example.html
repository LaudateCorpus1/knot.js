<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Test</title>

    <script src="../src/Knot.js"></script>
    <script src="../src/Knot.types.js"></script>
    <script src="../src/Knot.ext.js"></script>

    <style type="text/css">
        .selected {
            background-color:lemonchiffon;
            color:black;
        }
        .unselected {
            background-color:white;
            color:black;
        }
        .errorMessage {
            color:red;
        }

        #dataList {
            width:200px;
            height:400px;
            float:left;
            margin:10px;

            overflow-x:hidden;
            overflow-y:auto;

            border:1px solid gray;
        }
        #dataList > div {
            padding:5px;
            border:1px solid gray;
            margin:5px;
        }


        #editArea {
            width:500px;
            height:400px;

            padding:5px;
            text-align:left;

            float:left;
        }

        #editArea input {
            width:150px;
            text-align:left;
            margin:5px;
        }
        #editArea select {
            width:150px;
            text-align:left;
            margin:5px;
        }

        #editArea .fieldTitle {
            width:50px;
            display:inline-block;
            text-align:right;
        }

    </style>

    <script>
        //this is the model. it has two properties:
        //list: the array of the data. the list is bound with this property
        //selected: current selected data. the editing controls are bound with thie property
        //it is associated to Knot by dataContext attribute on "body" element
        var model = {list:[], selected:null};

        //here is everything start
        function onLoad() {
            //tie a knot! done!!
            Knot.tie();

            //when validating fails, set focus to the failed element.
            Knot.registerOnValidatingError(function (msg, node) {
                setTimeout(function () {
                    if (node.focus)
                        node.focus();
                }, 1);
            });
        }


        //call this function to validate all data. it is called when model.selected is changed.
        function validate() {
            var errMessage = Knot.validate(document.body);
            if (errMessage) {
                alert(errMessage);
                return false;
            }
            return true;
        }
        //event handler of "new" button
        function onNew() {
            if (!validate())
                return;
            //set default sex to "Male"
            var n = {sex:"Male"};
            //call Knot.addToArray, so that UI will refresh automatically
            Knot.addToArray(model.list, n);
            selectData(n);
        }

        //event handler of "remove" button
        function onRemove() {
            if (model.selected) {
                var index = model.list.indexOf(model.selected);
                Knot.removeFromArray(model.list, model.selected);
                if (model.list.length > 0) {
                    selectData(model.list[Math.min(model.list.length - 1, index)], true);
                }
                else {
                    //Use Knot.setValue to update data, so the UI will refresh
                    Knot.setValue(model, "selected", null);
                }
            }
        }

        //set the data to current selected data.
        //setting "model.selected" to update the edit controls, setting "isSelected" to update css on list items
        function selectData(data, ignoreValidating) {
            if (!ignoreValidating && !validate())
                return;
            Knot.setValue(data, "isSelected", true);
            Knot.setValue(model, "selected", data);

            for (var i = 0; i < model.list.length; i++) {
                if (model.list[i] != data) {
                    Knot.setValue(model.list[i], "isSelected", false);
                }
            }
        }

        //when any items are created in list, this is called. and we hook the onclick event to the
        //new item, so that we can switch selection to it when it is clicked.
        //it is associate to Knot by the "knotEvent" attribute in html.
        function onItemCreated(data, item) {
            item.onclick = function () {
                selectData(data);
            }
        }

        //these converters are used to change the values on data to anything you want them on html. You can create your own, it is super easy!
        //they are associate to Knot by "=>" mark in html
        var boolToClassConverter = Knot.Converters.createBoolToValue("selected", "unselected");
        var enableControl = Knot.Converters.createBoolToValue(false, true);
        var visibleControl = Knot.Converters.createBoolToValue("", "none");

        //these validators are used to validate the inputted value. the last one(duplicatedName) is used to check whether these's another one
        //with the same name. You can see how simple it is.
        var mustNotNull = Knot.Validators.createNotNull("Must not be null!");
        var checkInteger = Knot.Validators.createInteger("Must be integer");
        var ageRange = Knot.Validators.createValueRange(0, 150, "Must in 0~150!");
        var sexToTitle = Knot.Converters.createKeysToValues(["Male", "Female"], ["Mr.", "Miss."]);
        var duplicatedName = function (value, data) {
            for (var i = 0; i < model.list.length; i++) {
                if (model.list[i] == data)
                    continue;
                if (model.list[i].name == value) {
                    return value + " already exists!";
                }
            }
        }

        //options for the "From" select
        var countries = ["USA", "Japan", "China", "Australia"];
    </script>
</head>
<body onload="onLoad();" knotDataContext="/model">
<h2>Knot.js Example</h2>
<div>
    <div id="dataList" knots="foreach:*list" knotEvents="onItemCreated:onItemCreated">
        <div knots="class:*isSelected=>boolToClassConverter">
            <span knots="text:*sex=>sexToTitle"> </span><span knots="text:*name"></span>
            <hr/>
            Age:<span knots="text:*age"></span>,
            From:<span knots="text:*from"></span>
        </div>
    </div>
    <div id="editArea">
        <div>
            <div class="fieldTitle">Name:</div>
            <input type="text"
                   knots="value:*selected.name=!mustNotNull&duplicatedName, disabled:*selected=>enableControl"/>
            <span class="errorMessage" knots="style:{display:!selected.name=>visibleControl},text:!selected.name"></span>
        </div>
        <div>
            <div class="fieldTitle">Age:</div>
            <input type="text"
                   knots="value:*selected.age=!mustNotNull&checkInteger&ageRange, disabled:*selected=>enableControl" />
            <span class="errorMessage" knots="style:{display:!selected.age=>visibleControl},text:!selected.age"></span>
        </div>
        <div>
            <div class="fieldTitle">Sex:</div>
            <select knots="selected:*selected.sex,disabled:*selected=>enableControl">
                <option>Male</option>
                <option>Female</option>
            </select>
        </div>
        <div>
            <div class="fieldTitle">From:</div>
            <select knots="selected:*selected.from,disabled:*selected=>enableControl,foreach:/countries">
                <option knots="text:--self"></option>
            </select>
        </div>

        <p>
            <button onclick="onNew();">New</button>

            <button knots="disabled:*selected=>enableControl" onclick="onRemove()">Delete</button>
        </p>
    </div>
</div>
</body>
</html>
